name: E2E Tests (Playwright)

on:
  push:
    branches: [ main, master, develop, ci_changes, tests_improvements ]  # Include your test branches
  pull_request:
    # Run on ALL pull requests regardless of source/target branches
    types: [ opened, synchronize, reopened, ready_for_review ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  e2e-tests:
    name: Playwright E2E Tests
    timeout-minutes: 60
    runs-on: ubuntu-latest
    # Skip draft PRs
    if: github.event.pull_request.draft == false || github.event_name != 'pull_request'
    
    steps:
    - name: ğŸ“ E2E Test Info
      run: |
        echo "ğŸ­ Running Playwright E2E Tests (Frontend Only)"
        echo "ğŸ“‚ Event: ${{ github.event_name }}"
        echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
        echo "â„¹ï¸  Note: Unit tests run separately in CI Pipeline workflow"
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          echo "ğŸ”€ PR #${{ github.event.number }}: ${{ github.event.pull_request.title }}"
          echo "ğŸ‘¤ Author: ${{ github.event.pull_request.user.login }}"
        fi
        
    - name: Checkout frontend code
      uses: actions/checkout@v4
      with:
        path: frontend
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: Install frontend dependencies
      working-directory: frontend
      run: npm ci
      
    - name: Install Playwright Browsers
      working-directory: frontend
      run: npx playwright install --with-deps
      
    - name: Start frontend development server
      working-directory: frontend
      run: npm run dev &
      env:
        NEXT_PUBLIC_BACKEND_URL: http://localhost:8000/api/
        
    - name: Wait for frontend to be ready
      run: npx wait-on http://localhost:3000 --timeout 120000
      
    - name: Run Playwright tests
      working-directory: frontend
      run: |
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          echo "ğŸ”€ Running E2E tests for Pull Request"
          # For PRs, run tests with better output formatting
          npx playwright test --reporter=github
        else
          echo "ğŸš€ Running E2E tests for push to ${{ github.ref_name }}"
          npx playwright test
        fi
      env:
        CI: true
        NEXT_PUBLIC_BACKEND_URL: http://localhost:8000/api/
        
    - name: Stop frontend server
      if: always()
      run: |
        # Kill the dev server process
        pkill -f "next dev" || true
      
    - name: Upload Playwright report
      uses: actions/upload-artifact@v4
      if: ${{ !cancelled() }}
      with:
        name: playwright-report
        path: frontend/playwright-report/
        retention-days: 14
        
    - name: Comment on PR
      uses: actions/github-script@v7
      if: github.event_name == 'pull_request' && !cancelled()
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          let status = '${{ job.status }}';
          let emoji = status === 'success' ? 'âœ…' : 'âŒ';
          let statusText = status === 'success' ? 'PASSED' : 'FAILED';
          
          let comment = `## ğŸ­ Playwright E2E Tests ${emoji}\n\n`;
          comment += `**Status:** ${statusText}\n`;
          comment += `**Workflow:** [${context.runNumber}](${context.payload.repository.html_url}/actions/runs/${context.runId})\n`;
          comment += `**Commit:** ${context.sha.substring(0, 7)}\n\n`;
          comment += `â„¹ï¸  **Note:** This workflow only runs E2E tests. Unit tests and coverage are handled by the CI Pipeline workflow.\n\n`;
          
          if (status === 'success') {
            comment += 'ğŸ‰ All E2E tests passed! Your changes look good.\n\n';
          } else {
            comment += 'âŒ Some E2E tests failed. Please check the [test report]';
            comment += `(${context.payload.repository.html_url}/actions/runs/${context.runId}) for details.\n\n`;
          }
          
          comment += `<details>\n<summary>ğŸ“Š Test Details</summary>\n\n`;
          comment += `- **Test Type:** End-to-End (E2E) only\n`;
          comment += `- **Frontend Branch:** ${context.ref}\n`;
          comment += `- **Test Environment:** Frontend dev server with API mocking\n`;
          comment += `- **Unit Tests:** Run separately in CI Pipeline workflow\n`;
          comment += `- **Timeout:** 60 minutes\n`;
          comment += `</details>`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
